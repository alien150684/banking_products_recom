# Подготовка виртуальной машины

## Склонируйте репозиторий

Склонируйте репозиторий проекта:

```
git clone https://github.com/yandex-praktikum/mle-project-sprint-4-v001.git
```

## Активируйте виртуальное окружение

Используйте то же самое виртуальное окружение, что и созданное для работы с уроками. Если его не существует, то его следует создать.

Создать новое виртуальное окружение можно командой:

```
python3 -m venv env_recsys_start
```

После его инициализации следующей командой

```
. env_recsys_start/bin/activate
```

установите в него необходимые Python-пакеты следующей командой

```
pip install -r requirements.txt
```
установите переменные окружения

```
source .env
```
### Скачайте файлы с данными

Для начала работы понадобится три файла с данными:
- [tracks.parquet](https://storage.yandexcloud.net/mle-data/ym/tracks.parquet)
- [catalog_names.parquet](https://storage.yandexcloud.net/mle-data/ym/catalog_names.parquet)
- [interactions.parquet](https://storage.yandexcloud.net/mle-data/ym/interactions.parquet)
 
Скачайте их в директорию локального репозитория. Для удобства вы можете воспользоваться командой wget:

```
wget https://storage.yandexcloud.net/mle-data/ym/tracks.parquet

wget https://storage.yandexcloud.net/mle-data/ym/catalog_names.parquet

wget https://storage.yandexcloud.net/mle-data/ym/interactions.parquet
```

## Запустите Jupyter Lab

Запустите Jupyter Lab в командной строке

```
jupyter lab --ip=0.0.0.0 --no-browser
```

# Расчёт рекомендаций

Код для выполнения первой части проекта находится в файле `recommendations.ipynb`.

# Описание сервисов

Для тестирования рекомендательной системы должны быть запущены и параллельно работать три сервиса:
1) Cервис выдачи рекомендаций онлайн-, офлайн- и смешанных рекомендаций
```python
python app/recommendation_service.py
``` 
2) Cервис выдачи похожих объектов из файла "similar.parquet"
```python
python app/features_service.py
``` 
3) Сервис по методу /get возвращает события о взаимодействии пользователя с объектом: пару значений user_id и item_id
```python
python app/events_service.py
``` 
**Офлайн-рекомендации** (точка `/recommendations_offline`) являются персонализированными для пользователей с историей, а если таковая не найдена, то используем рекомендации по умолчанию: наиболее популярные треки. 

**Онлайн-рекомендации** (точка `/recommendations_online`) учитывают три последних объекта, с которыми взаимодействовал пользователь. Алгоритм получения онлайн-рекомендации: 
1) для каждого события из последних трёх получим список похожих объектов; 
2) объединим полученные списки по следующему правилу: все полученные похожие объекты сортируются по убыванию score, а из упорядоченного списка удаляются дубликаты, остаётся только первое вхождение.

Онлайн- и офлайн-рекомендаций смешиваются (точка `/recommendations`) для получения единого списка по следующему правилу:
1) онлайн-рекомендации занимают нечётные места в списке;
2) офлайн-рекомендации занимают чётные места в списке. 

# Инструкции для тестирования сервисов

Код для тестирования сервиса находится в файле `test_service.py`.

Тестирование микросервиса проводилось:
1) для пользователя с персональными рекомендациями (user_id = 0), с онлайн-историей и без неё;
2) для пользователя без персональных рекомендаций (user_id = 5555555555555555) с онлайн-историей и без неё.

Команда для запуска:
```python
python app/test_service.py
``` 
Вывод результатов был сохранён в файле `app/test_services.log`.
